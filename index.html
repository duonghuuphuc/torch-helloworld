<!DOCTYPE html>
<html lang="en-us">

<head>
    <meta charset="UTF-8">
    <title>Torch HelloWorld - Phuc Duong</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="Torch HelloWorld - Working with Torch in Windows Environment - Phuc Duong" />
    <meta name="keywords" content="Torch,Windows,HelloWorld,Phuc Duong,Duong Huu Phuc,Phuc H. Duong,Dương Hữu Phúc" />
    <meta property="og:title" content="Torch HelloWorld - Phuc Duong" />
    <meta property="og:type" content="website" />
    <meta property="og:url" content="http://torch.dhpit.com" />
    <meta property="og:image" content="http://torch.dhpit.com/img/dhp.png" />
    <meta property="og:description" content="Torch HelloWorld - Working with Torch in Windows Environment - Phuc Duong" />
    <link rel="stylesheet" type="text/css" href="stylesheets/normalize.css" media="screen">
    <link href='https://fonts.googleapis.com/css?family=Open+Sans:400,700' rel='stylesheet' type='text/css'>
    <link rel="stylesheet" type="text/css" href="stylesheets/stylesheet.css" media="screen">
    <link rel="stylesheet" type="text/css" href="stylesheets/github-light.css" media="screen">
    <link rel="icon" href="img/favicon.ico" type="image/x-icon" />
    <link rel="shortcut icon" href="img/favicon.ico" type="image/x-icon" />
    <link rel="author" href="https://plus.google.com/+HuuPhucDuong" />
</head>

<body>
    <section class="page-header">
        <h1 class="project-name">Torch HelloWorld</h1>
        <h2 class="project-tagline">Working with Torch in Windows Environment</h2>
        <a href="https://github.com/duonghuuphuc/torch-helloworld" class="btn" target="_blank">View on GitHub</a>
        <a href="https://github.com/duonghuuphuc/torch-helloworld/zipball/master" class="btn" target="_blank">Download .zip</a>
        <a href="https://github.com/duonghuuphuc/torch-helloworld/tarball/master" class="btn" target="_blank">Download .tar.gz</a>
    </section>

    <section class="main-content">
        <h2>
          <a id="introduction" class="anchor" href="#introduction" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Introduction
        </h2>

        <p>
            There are many Neural Network libraries available on the internet today. For example, you're familiar with Python, you can take advantage of <a href="https://www.tensorflow.org/" target="_blank">TensorFlow</a>, <a href="http://scikit-learn.org/"
                target="_blank">sci-kit learn</a>. Or Java, you can use <a href="https://deeplearning4j.org" target="_blank">DeepLearning4J</a>. From my mentor's recommendation, I switch to <a href="http://torch.ch/" target="_blank">Torch</a>, a good and
            easy to know framework for working with Neural Network models. In this article, I will focus on how-to use Torch for beginner, by going through my Hello World program. In my opinion, learning from Hello World program is a good approach for
            getting started with new programming language. Besides that, as my knowledge, until the day this article goes online, this's the first article introduces about working with <a href="http://torch.ch/" target="_blank">Torch</a> in Microsoft
            Windows environment in an easy way.
        </p>

        <p>
            <strong>Content</strong>
            <ol class="task-list">
                <li><a href="#prerequisites">Prerequisites</a></li>
                <li><a href="#neural-network-with-torch">Neural Network with Torch</a></li>
                <ol class="task-list">
                    <li><a href="#model">Model</a></li>
                    <li><a href="#training">Training</a></li>
                    <li><a href="#data">Data</a></li>
                    <li><a href="#evaluation">Evaluation</a></li>
                </ol>
                <li><a href="#contributors">Contributors</a></li>
				<li><a href="#contact">Contact</a></li>
            </ol>
        </p>

        <h2>
          <a id="prerequisites" class="anchor" href="#prerequisites" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Prerequisites
        </h2>

        <p>
            In order to working with my example program, and also know what I'll present, you need have the following prerequisites:
            <ul class="task-list">
                <li>Microsoft Windows 10 (Version 1607), aka Windows 10 Anniversary Update</li>
                <li><strong>Bash on Ubuntu on Windows</strong> is enabled [<a href="https://msdn.microsoft.com/en-us/commandline/wsl/install_guide" target="_blank">Readme</a>]</li>
                <li><strong>Torch</strong> is installed in virtual Ubuntu on Windows [<a href="http://torch.ch/docs/getting-started.html" target="_blank">Readme</a>]</li>
                <li>Basic understanding of <strong>Lua</strong> programming language [<a href="https://www.tutorialspoint.com/lua/" target="_blank">Readme</a>]</li>
                <li>Basic understanding of machine learning, artificial neural network [<a href="http://cs229.stanford.edu/" target="_blank">ML</a> | <a href="https://en.wikipedia.org/wiki/Artificial_neural_network" target="_blank">ANN</a>]</li>
            </ul>
        </p>

        <h2>
          <a id="neural-network-with-torch" class="anchor" href="#neural-network-with-torch" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Neural Network with Torch
        </h2>

        <p>
            In Torch, the <code>nn</code> is the main package to build and train from simple to complex neural network model. To begin working with Torch, you need to define the following things:
            <ul class="task-list">
                <li>Model</li>
                <li>Training</li>
                <li>Data</li>
                <li>Evaluation</li>
            </ul>
        </p>

        <h3>
          <a id="model" class="anchor" href="#model" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Model
        </h3>

        <p>
            The first thing in working with Torch is that you need to define a model. For example, you want a feed-forward network, a convolutional network, or a recurrent neural network. You also define the number of hidden layers, the number of hidden units for
            each layer, and the activation function which you want to use on each layer.<br> The <code>nn</code> package defines the containers as follows:
            <ul class="task-list">
                <li><code>nn.Sequential</code>: plugs layers in a feed-forward fully connected manner</li>
                <li><code>nn.Parallel</code>: plugs each element of input Tensor to different layers</li>
                <li><code>nn.Concat</code>: concatenates in one layer several modules along dimension <code>dim</code></li>
                <li><code>nn.Bottle</code>: allows any dimensionality input be forwarded through a module</li>
            </ul>
            In many cases, we use <code>nn.Sequential</code> since it's the most easy approach to feed data to the network, thus the program will look like:<br>
            <pre>
              <code>
                require "nn"
                mlp = nn.Sequential()
              </code>
            </pre><br> Next, to tranform data between layers, we can simply use the linear transfer function (<code>nn.Linear</code>) or the non-linear representation of input data (<code>nn.Sigmoid</code>, <code>nn.Tanh</code>,
            <code>nn.ReLU</code>, ...). Let's assume that we want a network with two hidden layers, a 4-dimensional input, 4 units in each layer, and the transfer function is <code>nn.Tanh</code>.
            <pre>
              <code>
                input = 4
                output = 2
                hiddenLayer1 = 4
                hiddenLayer2 = 4<br>
                mlp:add(nn.Linear(input, hiddenLayer1))
                mlp:add(nn.Tanh())
                mlp:add(nn.Linear(hiddenLayer1, hiddenLayer2))
                mlp:add(nn.Tanh())
                mlp:add(nn.Linear(hiddenLayer2, output))
                mlp:add(nn.LogSoftMax())
              </code>
            </pre> The last two lines in above program declare the output layer. In this case, we define an output in 2-dimension, that means, our task is binary classificaton, and thus the <code>nn.LogSoftMax()</code> is the most common choice.<br>We
            should print our model to check whether it fits our need, by insert the following line:
            <pre>
              <code>
                print(mlp)
              </code>
            </pre> Now, at this point of the program, you can compile and run it. To execute this program, first, you have to save this file with the file extension is <code>.lua</code>, for example, named <code>sample.lua</code>. Then, open
            the <strong>Bash on Ubuntu on Windows</strong>, and type the command as follows (you can use the <code>cd</code> command to change to directory of your saved file).
            <pre>
              <code>
                <strong>th</strong> sample.lua
              </code>
            </pre> The program is executed, and print the following lines on the screen:
            <pre>
              <code>
                nn.Sequential {
                  [input -> (1) -> (2) -> (3) -> (4) -> output]
                  (1): nn.Linear(4 -> 4)
                  (2): nn.Tanh
                  (3): nn.Linear(4 -> 2)
                  (4): nn.LogSoftMax
                }
              </code>
            </pre> To pre-test your model properly works and do what it's supposed to do, you can take the advantage of <code>Module:forward</code>.
            <pre>
              <code>
                preTest = mlp:forward(torch.randn(1,10))
                print(preTest)
              </code>
            </pre> When execute the program, it will return a Tensor data of size <code>1 x 2</code>, in which the <code>preTest[1][i]</code> is log probability belongs to class <code>i</code> of the input, respectively. Note that, in Lua,
            the index of <code>Tensor</code> starts at <code>1</code>. Below is the graphical representation of our NN model.<br><br>
            <!-- INSERT IMAGE HERE ! -->
            <img src="img/nn.png" alt="Neural Network Model" title="Neural network model with 4-d input, 2 hidden layers, and 2-d output.">
        </p>

        <h3>
          <a id="training" class="anchor" href="#training" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Training
        </h3>

        <p>
            In previous section, we had our NN model. Now, we have to define a training algorithm, as <code>nn</code> package provides us two approaches: (1) implement your own training algorithm, that means, you define from taking input, feeding to layers,
            computing gradients, and update model's paremeters; or (2) you can take advantage of pre-implemented <code>nn.StochasticGradient</code> method. The <code>nn.StochasticGradient</code> takes the our defined model, and a loss function (<code>Criterion</code>).
            There are many <code>Criterion</code> in <code>nn</code> package (<em>e.g.</em>, <code>CrossEntropyCriterion</code>, <code>MSECriterion</code>, <code>CosineEmbeddingCriterion</code>), and we use the negative log-likelihood criterion, since
            it usually goes with <code>nn.LogSoftMax</code>. Besides that, another important parameter for <code>nn.StochasticGradient</code> is <code>learningRate</code>.

            <pre>
              <code>
                criterion = nn.ClassNLLCriterion()
                trainer = nn.StochasticGradient(mlp, criterion)
                trainer.learningRate = 0.1
              </code>
            </pre>
        </p>

        <h3>
          <a id="data" class="anchor" href="#data" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Data
        </h3>

        <p>
            Until now, the last important thing is training dataset. Let's assume our dataset is stored in <a href="https://en.wikipedia.org/wiki/Comma-separated_values" target="_blank">CSV</a> format. Since Torch doesn't support splitting method, we
            need to define such method as follows.

            <pre>
              <code>
                <span style="color:green">-- Split input string at comma symbols</span>
                <strong>function</strong> string:splitAtCommas()
                  <strong><strong>local</strong></strong> sep, output = ",", {}
                  <strong><strong>local</strong></strong> pattern = string.format("([^%s]+)", sep)
                  self:<strong>gsub</strong>(pattern, <strong>function</strong>(c) output[#output+1] = c <strong>end</strong>)
                  <strong>return</strong> output
                <strong>end</strong>

                <span style="color:green">-- Read the dataFile and return a variable in Tensor data structure</span>
                <strong>function</strong> loadData(dataFile)
                  <strong><strong>local</strong></strong> dataset = {}
                  <strong><strong>local</strong></strong> i = 1
                  <strong>for</strong> line in io.lines(dataFile) <strong>do</strong>
                    <strong><strong>local</strong></strong> values = line:splitAtCommas()
                    <strong><strong>local</strong></strong> y = torch.Tensor(1)
                    y[1] = values[#values]	-- the last number in line is class
                    values[#values] = nil
                    <strong><strong>local</strong></strong> x = torch.Tensor(values)	-- all other numbers are input
                    dataset[i] = {x, y}
                    i = i + 1
                  <strong>end</strong>
                  <strong>function</strong> dataset:size() return (i - 1) <strong>end</strong>  -- the requirement mentioned
                  <strong>return</strong> dataset
                <strong>end</strong>
              </code>
            </pre> Then, the method <code>nn.StochasticGradient:train</code> is called to begin training process.

            <pre>
              <code>
                <span style="color:green">---- Load the dataset</span>
                dataset = loadData("train.csv")

                <span style="color:green">---- Training model with given dataset</span>
                trainer:train(dataset)
              </code>
            </pre>
        </p>

        <h3>
          <a id="evaluation" class="anchor" href="#evaluation" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Evaluation
        </h3>

        <p>
            After successfully training our NN model, we now need to evaluate and compute the accuracy of our model. This step can be done by using the two functions below. The first one, named <code>argmax(v)</code>, and the second is <code>evluation(filePath)</code>,
            which takes the test dataset (in CSV format) and returns the accuracy of the current model (in percentage).
            <pre>
              <code>
                <span style="color:green">---- argmax</span>
                <strong>function</strong> argmax(v)
                  <strong>local</strong> max = torch.max(v)
                  <strong>for</strong> i = 1, v:size(1) <strong>do</strong>
                    <strong>if</strong> v[i] == max <strong>then</strong>
                      <strong>return</strong> i
                    <strong>end</strong>
                  <strong>end</strong>
                <strong>end</strong>

                <span style="color:green">---- Evaluate and compute the accuracy</span>
                <strong>function</strong> evaluation(filePath)
                  <strong>local</strong> total = 0
                  <strong>local</strong> positive = 0

                  <strong>for</strong> line in io.lines(filePath) <strong>do</strong>
                    <strong>local</strong> values = line:splitAtCommas()
                    <strong>local</strong> y = torch.Tensor(1)
                    y[1] = values[#values]
                    values[#values] = nil
                    <strong>local</strong> x = torch.Tensor(values)
                    <strong>local</strong> prediction = argmax(mlp:forward(x))
                    <strong>if</strong> math.floor(prediction) == math.floor(y[1]) <strong>then</strong>
                      positive = positive + 1
                    <strong>end</strong>
                    total = total + 1
                  <strong>end</strong>

                  <strong>return</strong> (positive / total) * 100
                <strong>end</strong>

                <span style="color:green">---- Read the testset and compute the accuracy</span>
                accuracy = evaluation("test.csv")
                print("Accuracy(%) is " .. accuracy)
              </code>
            </pre> If we want to view the weight matrices of our model, we can use the command below.

            <pre>
              <code>
                <span style="color:green">---- Print the weight matrix</span>
                print("Weights of saved model: ")
                print(mlp:get(1)) <span style="color:green;font-style:italic">-- Get the first module of our model, i.e. nn.Linear(4 -> 4)</span>
                print(mlp:get(1).weight)  <span style="color:green;font-style:italic">-- Get the weight matrix of that layer</span>
              </code>
            </pre> In case we want to save the model and load it later, we can use the following lines of code.

            <pre>
              <code>
                <span style="color:green">---- Save the model to file</span>
                torch.save("file.th", mlp)

                <span style="color:green">---- Load the saved model</span>
                mlp2 = torch.load("file.th")
                print(mlp2:get(1).weight)
              </code>
            </pre>
        </p>

        <h2>
          <a id="contributors" class="anchor" href="#contributors" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Contributors
        </h2>

        <p>
            <ul class="task-list">
                <li>Phuc Duong - <a href="mailto:huuphucduong@gmail.com">huuphucduong@gmail.com</a></li>
                <li>Duy Nguyen <em>(Student)</em> -
                    <a href="mailto:nguyentuthanhduy@outlook.com">nguyentuthanhduy@outlook.com</a>
                </li>
                <li>Huy Nguyen <em>(Student)</em> -
                    <a href="mailto:nguyentuthanhduy@outlook.com">nguyenmanhhuy01@gmail.com</li>
            </ul>
        </p>

        <h2>
          <a id="contact" class="anchor" href="#contact" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Contact
		</h2>

		<p>
			This tutorial may contain mistakes, thus I appreciate your feedback if you find some of them. Please feel free to send to me or one of my student an email!
		</p>

		<!-- FOOTER -->
		<footer class="site-footer">
			<span class="site-footer-owner"><a href="https://github.com/duonghuuphuc/torch-helloworld" target="_blank">Torch HelloWorld</a> is maintained by <a href="http://it.tdt.edu.vn/~dhphuc/" target="_blank" title="Lecturer, Faculty of Information Technology, Ton Duc Thang University, Vietnam">Phuc Duong</a>.</span>
			<span class="site-footer-credits">&copy; 2016 DHPIT.</span>
		</footer>

    </section>


</body>

</html
